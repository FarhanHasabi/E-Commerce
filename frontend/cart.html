<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Keranjang - Glamora</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Menggunakan Poppins sebagai default, Playfair untuk judul */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f7f9fb;
            color: #333;
            /* PERBAIKAN FOOTER: Mengatur Body sebagai Flex Container */
            display: flex;
            flex-direction: column;
        }
        main {
            /* PERBAIKAN FOOTER: Konten utama mengambil sisa ruang */
            flex-grow: 1; 
        }
        .font-playfair {
            font-family: 'Playfair Display', serif;
        }
        /* Custom style untuk layout grid keranjang */
        .cart-layout {
            display: grid;
            gap: 2rem;
            grid-template-columns: 1fr; /* Default 1 kolom untuk mobile */
        }
        @media (min-width: 768px) {
            .cart-layout {
                grid-template-columns: 2fr 1fr; /* 2:1 kolom untuk desktop */
            }
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="bg-white shadow-md sticky top-0 z-10">
        <nav class="container mx-auto p-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center">
                <img src="assets/img/logo.png" alt="Glamora Logo" class="h-8 md:h-10 w-auto" />
            </a>
            <ul class="flex space-x-6 text-sm font-medium">
                <li><a href="index.html" class="text-gray-700 hover:text-pink-600 transition">Home</a></li>
                <li><a href="category.html" class="text-gray-700 hover:text-pink-600 transition">Category</a></li>
                <li><a href="cart.html" class="text-pink-600 font-semibold transition border-b-2 border-pink-600">Shopping Cart</a></li>
                <li><a href="checkout.html" class="text-gray-700 hover:text-pink-600 transition">Checkout</a></li>
                <li><a href="contact.html" class="text-gray-700 hover:text-pink-600 transition">Contact</a></li>
                <li><a href="login.html" class="bg-pink-500 text-white px-3 py-1 rounded-full hover:bg-pink-600 transition shadow-lg" id="loginBtn">Login</a></li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto p-6 md:p-8">
        <h1 class="text-4xl font-playfair font-bold text-gray-800 mb-8 border-b-2 border-pink-200 pb-3">Shopping Cart</h1>

        <div class="cart-layout">
            <section class="space-y-4">
                <div id="cartItems">
                    <div class="p-8 bg-white rounded-xl shadow-lg text-center text-gray-500 font-medium" id="loadingMessage">Memuat keranjang Anda...</div>
                </div>
    
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 mt-6 bg-white rounded-xl shadow-md border border-gray-100">
                    <a href="category.html" class="text-pink-600 hover:text-pink-700 font-medium mb-4 sm:mb-0">
                        <span class="text-2xl mr-2">←</span> Lanjut Belanja
                    </a>
                    <div class="space-x-4">
                        <button class="px-5 py-2 rounded-full text-white bg-red-500 hover:bg-red-600 transition shadow-md font-medium" id="clearCartBtn">
                            Clear Cart
                        </button>
                        <button class="px-6 py-2 rounded-full text-white bg-pink-600 hover:bg-pink-700 transition shadow-xl font-semibold" id="checkoutBtn" disabled>
                            Lanjut ke Checkout
                        </button>
                    </div>
                </div>
            </section>
    
            <aside class="h-fit bg-white p-6 rounded-xl shadow-2xl border-t-4 border-pink-600">
                <h3 class="text-2xl font-playfair font-bold mb-4 text-gray-800">Order Summary</h3>
                <div class="space-y-3 border-b pb-4 mb-4">
                    <div class="flex justify-between text-lg text-gray-600">
                        <span>Subtotal Barang:</span>
                        <strong id="subtotalDisplay" class="text-gray-800">Rp0</strong>
                    </div>
                </div>
                <div class="flex justify-between text-xl font-bold text-gray-900">
                    <span>Total Pembayaran:</span>
                    <strong id="totalGrandDisplay" class="text-pink-600">Rp0</strong>
                </div>
                <p class="text-xs text-gray-500 mt-2">Total ini belum termasuk biaya kirim.</p>
            </aside>
        </div>
    </main>

    <footer class="bg-gray-800 text-white p-6 mt-12">
        <div class="container mx-auto text-center">
            <p>&copy; 2024 Glamora. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // =======================================================
        // ⚠️ GANTI DENGAN KUNCI SUPABASE ANDA ⚠️
        // =======================================================
        const SUPABASE_URL = 'https://pykzuzlcqumlpbxuhvnk.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a3p1emxjcXVtbHBieHVodm5rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNTQ4NjAsImV4cCI6MjA3NDgzMDg2MH0.P8ofbHa0UhBTwCRDdpX8c8-zx8gNwKFpDln0VsPYXTc'; 
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // --- Global Helper Functions ---
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        function handleLogout(e) {
            e.preventDefault();
            localStorage.removeItem("isLoggedIn");
            localStorage.removeItem("userName");
            // Supabase client logout
            supabase.auth.signOut().then(() => {
                location.reload(); 
            });
        }
        
        function updateAuthStatus() {
            const loginBtn = document.getElementById("loginBtn");
            if (!loginBtn) return;
            
            const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
            const userName = localStorage.getItem("userName");

            if (isLoggedIn && userName) {
                loginBtn.textContent = `Hi, ${userName.split(' ')[0]}`; 
                loginBtn.href = "#"; 
                loginBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                loginBtn.classList.remove('bg-pink-500', 'hover:bg-pink-600');
                
                loginBtn.removeEventListener('click', handleLogout); 
                loginBtn.addEventListener('click', handleLogout); 
                
            } else {
                loginBtn.textContent = `Login`; 
                loginBtn.href = "login.html";
                loginBtn.classList.add('bg-pink-500', 'hover:bg-pink-600');
                loginBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                loginBtn.removeEventListener('click', handleLogout); 
            }
        }
        // --- Akhir Global Helper Functions ---
        
        document.addEventListener("DOMContentLoaded", async function () {
            
            updateAuthStatus();
            
            const cartContainer = document.getElementById("cartItems");
            const loadingMessage = document.getElementById("loadingMessage");
            const subtotalDisplay = document.getElementById("subtotalDisplay");
            const totalGrandDisplay = document.getElementById("totalGrandDisplay");
            const clearCartBtn = document.getElementById("clearCartBtn");
            const checkoutBtn = document.getElementById("checkoutBtn");
            
            // Cek apakah user sudah login
            const { data: { user } } = await supabase.auth.getUser();

            if (!user) {
                // Tampilkan pesan jika belum login
                loadingMessage.innerHTML = '<p class="text-red-500 font-bold">Anda harus <a href="login.html" class="text-pink-600 hover:underline">login</a> untuk melihat keranjang Anda.</p>';
                checkoutBtn.disabled = true;
                checkoutBtn.classList.add('opacity-50', 'cursor-not-allowed');
                clearCartBtn.disabled = true;
                clearCartBtn.classList.add('opacity-50', 'cursor-not-allowed');
                return; 
            }

            // Fungsi untuk menghitung dan menampilkan total
            function updateSummary(currentSubtotal) {
                const grandTotal = currentSubtotal; 
                subtotalDisplay.textContent = formatRupiah(currentSubtotal);
                totalGrandDisplay.textContent = formatRupiah(grandTotal);
            }

            let cart = []; // Variabel global untuk menyimpan item dari Supabase

            // ⭐️ LOGIKA BARU: Mengambil keranjang dari Supabase
            async function loadCart() {
                loadingMessage.style.display = 'block';
                cartContainer.innerHTML = ''; // Kosongkan
                cartContainer.appendChild(loadingMessage); // Tampilkan loading
                
                const { data, error } = await supabase
                    .from('carts')
                    .select('*') // Ambil semua kolom
                    .eq('user_id', user.id); // Filter berdasarkan user yang sedang login (RLS harus aktif)

                loadingMessage.style.display = 'none';

                if (error) {
                    console.error("Gagal memuat keranjang:", error.message);
                    cartContainer.innerHTML = '<div class="p-8 bg-white rounded-xl shadow-lg text-center text-red-500 font-medium"><p>Gagal memuat keranjang. Pastikan RLS di tabel carts sudah benar.</p></div>';
                    updateSummary(0);
                    checkoutBtn.disabled = true;
                    checkoutBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    return;
                }

                cart = data || []; // Simpan data keranjang
                let subtotal = 0;

                if (cart.length === 0) {
                    cartContainer.innerHTML = '<div class="p-8 bg-white rounded-xl shadow-lg text-center text-gray-500 font-medium"><p>Keranjang belanja Anda kosong. Yuk, cari produk favorit Anda!</p></div>';
                    updateSummary(0);
                    checkoutBtn.disabled = true;
                    checkoutBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    clearCartBtn.disabled = true;
                    clearCartBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    return;
                }
                
                checkoutBtn.disabled = false;
                checkoutBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                clearCartBtn.disabled = false;
                clearCartBtn.classList.remove('opacity-50', 'cursor-not-allowed');

                cart.forEach(item => {
                    const totalHarga = item.price * item.quantity;
                    subtotal += totalHarga;

                    const itemEl = document.createElement("div");
                    itemEl.classList.add("cart-card", "bg-white", "p-4", "rounded-xl", "shadow-lg", "flex", "space-x-4", "items-center", "border", "border-pink-100");
                    
                    itemEl.innerHTML = `
                        <img src="${item.image || 'https://placehold.co/80x80/f0abfc/701a75?text=Img'}" alt="${item.name}" class="w-20 h-20 object-cover rounded-md flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/80x80/f0abfc/701a75?text=Img';" />
                        <div class="flex-grow">
                            <h4 class="text-lg font-semibold text-gray-800">${item.name}</h4>
                            <p class="text-sm text-gray-500">Harga Satuan: ${formatRupiah(item.price)}</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="text-md text-gray-700">Jumlah: <span class="font-medium">${item.quantity}</span></p>
                            <p class="text-xl font-bold text-pink-600 mt-1">${formatRupiah(totalHarga)}</p>
                        </div>
                    `;
                    cartContainer.appendChild(itemEl);
                });

                updateSummary(subtotal);
            }

            // Jalankan load cart saat halaman dimuat
            loadCart();

            // ⭐️ LOGIKA BARU: Event Listener untuk Clear Cart (menghapus dari Supabase)
            clearCartBtn.addEventListener("click", async () => {
                if (!confirm("Apakah Anda yakin ingin mengosongkan keranjang?")) return;
                
                clearCartBtn.textContent = 'Clearing...';
                clearCartBtn.disabled = true;
                
                const { error } = await supabase
                    .from('carts')
                    .delete()
                    .eq('user_id', user.id); // Hapus semua item user ini (RLS penting!)

                if (error) {
                    console.error("Gagal mengosongkan keranjang:", error.message);
                    alert("Gagal mengosongkan keranjang. Coba lagi.");
                } else {
                    console.log("Keranjang dikosongkan dari Supabase.");
                }
                
                // Reload halaman untuk refresh tampilan
                location.reload(); 
            });

            // Event Listener untuk Checkout (menyimpan data Supabase ke Session Storage sebelum redirect)
            checkoutBtn.addEventListener("click", () => {
                // Simpan data keranjang yang sudah di-fetch dari Supabase ke Session Storage
                // agar halaman checkout (yang tidak menggunakan Supabase) dapat membacanya.
                sessionStorage.setItem("cartItems", JSON.stringify(cart)); 
                window.location.href = "checkout.html";
            });
        });
    </script>
</body>
</html>