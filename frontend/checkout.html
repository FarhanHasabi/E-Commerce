<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - Glamora</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Menggunakan Poppins sebagai default, Playfair untuk judul (Consistent with cart.html) */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f7f9fb; /* Warna latar belakang dari cart.html */
            color: #333;
            /* Mengatur Body sebagai Flex Container agar footer di bawah */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            /* Konten utama mengambil sisa ruang */
            flex-grow: 1; 
        }
        .font-playfair {
            font-family: 'Playfair Display', serif;
        }
        /* Custom style untuk layout grid checkout (Menyesuaikan dengan Cart Layout) */
        .checkout-layout {
            display: grid;
            gap: 2rem;
            padding: 2rem 1rem;
        }
        @media (min-width: 1024px) {
            .checkout-layout {
                grid-template-columns: 2fr 1fr;
            }
        }
        /* Style untuk pesan notifikasi */
        .custom-message {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .custom-message.show {
            opacity: 1;
        }
        .custom-message.success {
            background-color: #48bb78; /* Green */
        }
        .custom-message.warning {
            background-color: #ecc94b; /* Yellow */
        }
    </style>
</head>
<body>
    
    <header class="bg-white shadow-md sticky top-0 z-10">
        <nav class="container mx-auto p-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center">
                <img src="assets/img/logo.png" alt="Glamora Logo" class="h-8 md:h-10 w-auto" />
            </a>
            <ul class="flex space-x-6 text-sm font-medium">
                <li><a href="index.html" class="text-gray-700 hover:text-pink-600 transition">Home</a></li>
                <li><a href="category.html" class="text-gray-700 hover:text-pink-600 transition">Category</a></li>
                <li><a href="cart.html" class="text-gray-700 hover:text-pink-600 transition">Shopping Cart</a></li>
                <li><a href="checkout.html" class="text-pink-600 font-semibold transition border-b-2 border-pink-600">Checkout</a></li>
                <li><a href="contact.html" class="text-gray-700 hover:text-pink-600 transition">Contact</a></li>
                <li><a href="login.html" class="bg-pink-500 text-white px-3 py-1 rounded-full hover:bg-pink-600 transition shadow-lg" id="loginBtn">Login</a></li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-8 flex-grow">
        <h1 class="text-4xl font-playfair font-bold text-gray-800 mb-8 border-b-2 border-pink-200 pb-3">Checkout</h1>

        <div class="checkout-layout max-w-7xl mx-auto">
            
            <div class="billing-details bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Detail Pengiriman</h2>
                <form id="checkoutForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                            <input type="text" id="fullName" name="fullName" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:border-pink-500 focus:ring-pink-500">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="email" name="email" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:border-pink-500 focus:ring-pink-500">
                        </div>
                    </div>
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700">Alamat Lengkap</label>
                        <textarea id="address" name="address" rows="3" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:border-pink-500 focus:ring-pink-500"></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="city" class="block text-sm font-medium text-gray-700">Kota</label>
                            <input type="text" id="city" name="city" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:border-pink-500 focus:ring-pink-500">
                        </div>
                        <div>
                            <label for="postalCode" class="block text-sm font-medium text-gray-700">Kode Pos</label>
                            <input type="text" id="postalCode" name="postalCode" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:border-pink-500 focus:ring-pink-500">
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700">Nomor Telepon</label>
                            <input type="tel" id="phone" name="phone" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:border-pink-500 focus:ring-pink-500">
                        </div>
                    </div>

                    <h2 class="text-2xl font-semibold text-gray-800 pt-6 mb-4 border-t border-gray-100">Metode Pembayaran</h2>
                    <div class="space-y-2" id="paymentMethodsContainer">
                        <label class="flex items-center p-3 border border-pink-300 bg-pink-50 rounded-lg cursor-pointer hover:bg-pink-100 transition payment-option-label">
                            <input type="radio" name="paymentMethod" value="transfer" required class="h-4 w-4 text-pink-600 border-gray-300 focus:ring-pink-500" checked>
                            <span class="ml-3 text-gray-700 font-medium">Transfer Bank (BCA / Mandiri)</span>
                        </label>
                        <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition payment-option-label">
                            <input type="radio" name="paymentMethod" value="dana" required class="h-4 w-4 text-pink-600 border-gray-300 focus:ring-pink-500">
                            <span class="ml-3 text-gray-700 font-medium">E-Wallet (Dana / GoPay)</span>
                        </label>
                        <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition payment-option-label">
                            <input type="radio" name="paymentMethod" value="cod" required class="h-4 w-4 text-pink-600 border-gray-300 focus:ring-pink-500">
                            <span class="ml-3 text-gray-700 font-medium">Cash On Delivery (COD)</span>
                        </label>
                    </div>

                    <div class="pt-6">
                        <button type="submit" class="w-full py-4 px-4 border border-transparent rounded-lg shadow-md text-xl font-medium text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 transition">
                            Bayar Sekarang
                        </button>
                    </div>
                </form>
            </div>

            <div class="order-summary bg-white p-6 rounded-xl shadow-lg h-fit sticky top-24">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Ringkasan Pesanan</h2>
                
                <div id="summaryItems" class="space-y-4 border-b pb-4 mb-4">
                    <p class="text-gray-500 italic">Memuat item...</p>
                </div>
                
                <div class="space-y-3">
                    <div class="flex justify-between text-gray-600">
                        <span>Subtotal Barang</span>
                        <span id="subtotal">Rp 0</span>
                    </div>
                    <div class="flex justify-between text-2xl font-bold text-gray-800 border-t pt-3 mt-3">
                        <span>Total Pembayaran</span>
                        <span id="totalAmount">Rp 0</span>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                    <p class="text-sm text-yellow-800 font-medium">Pastikan semua detail pengiriman sudah benar sebelum melakukan pembayaran.</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white p-6 mt-12">
        <div class="container mx-auto text-center">
            <p>&copy; 2024 Glamora. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // =======================================================
        // ⚠️ GANTI DENGAN KUNCI SUPABASE ANDA ⚠️
        // =======================================================
        const SUPABASE_URL = 'https://pykzuzlcqumlpbxuhvnk.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a3p1emxjcXVtbHBieHVodm5rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNTQ4NjAsImV4cCI6MjA3NDgzMDg2MH0.P8ofbHa0UhBTwCRDdpX8c8-zx8gNwKFpDln0VsPYXTc'; 
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Global Helper Functions ---
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        function showCustomMessage(message, type) {
            let msgEl = document.querySelector('.custom-message');
            if (msgEl) msgEl.remove();

            msgEl = document.createElement('div');
            msgEl.className = `custom-message ${type}`;
            msgEl.textContent = message;
            
            document.body.appendChild(msgEl);
            
            // Tampilkan dengan transisi
            setTimeout(() => {
                msgEl.classList.add('show');
            }, 10);

            // Hilangkan setelah 5 detik
            setTimeout(() => {
                msgEl.classList.remove('show');
                setTimeout(() => msgEl.remove(), 500); // Tunggu transisi selesai
            }, 5000);
        }

        // --- Logika Autentikasi dan Navbar ---
        async function handleLogout(e) {
            e.preventDefault();
            localStorage.removeItem("isLoggedIn");
            localStorage.removeItem("userName");
            // ⭐️ Logout Supabase
            await supabase.auth.signOut();
            
            showCustomMessage("Anda berhasil logout.", 'success');
            setTimeout(() => {
                window.location.reload(); 
            }, 1000);
        }

        function updateAuthStatus() {
            const loginBtn = document.getElementById("loginBtn");
            if (!loginBtn) return;
            
            const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
            const userName = localStorage.getItem("userName");

            if (isLoggedIn && userName) {
                loginBtn.textContent = `Hi, ${userName.split(' ')[0]}`; 
                loginBtn.href = "#"; 
                loginBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                loginBtn.classList.remove('bg-pink-500', 'hover:bg-pink-600');
                
                loginBtn.removeEventListener('click', handleLogout); 
                loginBtn.addEventListener('click', handleLogout); 
                
            } else {
                loginBtn.textContent = `Login`; 
                loginBtn.href = "login.html";
                loginBtn.classList.add('bg-pink-500', 'hover:bg-pink-600');
                loginBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                loginBtn.removeEventListener('click', handleLogout); 
            }
        }
        // --- Akhir Logika Autentikasi dan Navbar ---

        // --- Logika Highlighting Pilihan Pembayaran ---
        function setupPaymentHighlighting() {
            const paymentContainer = document.getElementById('paymentMethodsContainer');
            if (!paymentContainer) return;
            
            const activeClasses = ['border-pink-300', 'bg-pink-50'];
            
            const labels = paymentContainer.querySelectorAll('.payment-option-label');

            labels.forEach(label => {
                const radio = label.querySelector('input[type="radio"]');
                
                radio.addEventListener('change', () => {
                    labels.forEach(l => {
                        l.classList.remove(...activeClasses);
                        l.classList.add('border-gray-300', 'bg-white', 'hover:bg-gray-50');
                        l.classList.remove('hover:bg-pink-100');
                    });

                    if (radio.checked) {
                        label.classList.add(...activeClasses);
                        label.classList.remove('border-gray-300', 'bg-white', 'hover:bg-gray-50');
                        label.classList.add('hover:bg-pink-100'); 
                    }
                });

                if (radio.checked) {
                    label.classList.remove('border-gray-300', 'bg-white', 'hover:bg-gray-50');
                    label.classList.add(...activeClasses);
                    label.classList.add('hover:bg-pink-100');
                } else {
                    label.classList.remove(...activeClasses);
                    label.classList.add('border-gray-300', 'bg-white', 'hover:bg-gray-50');
                    label.classList.remove('hover:bg-pink-100');
                }
            });
        }
        // --- Akhir Logika Highlighting Pilihan Pembayaran ---


        document.addEventListener("DOMContentLoaded", async function () {
            
            // Panggil fungsi autentikasi
            updateAuthStatus();
            
            // Panggil fungsi highlighting pembayaran
            setupPaymentHighlighting();

            const summaryItems = document.getElementById('summaryItems');
            const subtotalEl = document.getElementById('subtotal');
            const totalAmountEl = document.getElementById('totalAmount');
            const checkoutForm = document.getElementById('checkoutForm');
            
            let total = 0;
            let cartItems = [];
            
            // ⭐️ Cek apakah user sudah login, jika tidak, redirect
            const { data: { user } } = await supabase.auth.getUser();

            if (!user) {
                alert("Anda harus login untuk melanjutkan ke checkout.");
                window.location.href = "login.html";
                return;
            }
            
            // Load Cart Items dari Session Storage (telah dimuat dari Supabase saat login)
            function loadCart() {
                const cartData = sessionStorage.getItem("cartItems"); 
                cartItems = cartData ? JSON.parse(cartData) : [];
                
                let subtotal = 0;
                
                if (cartItems.length === 0) {
                    summaryItems.innerHTML = '<p class="text-red-500 italic">Keranjang Anda kosong. Mohon tambahkan produk. Anda akan dialihkan...</p>';
                    total = 0;
                    // Redirect jika keranjang kosong
                    setTimeout(() => {
                        window.location.href = "cart.html";
                    }, 2000);
                } else {
                    summaryItems.innerHTML = ''; // Clear loading message

                    cartItems.forEach(item => {
                        // Catatan: Asumsi item memiliki struktur { name, price, quantity } dari Supabase carts
                        const itemTotal = item.price * item.quantity;
                        subtotal += itemTotal;

                        const itemEl = document.createElement('div');
                        itemEl.className = 'flex justify-between text-sm text-gray-700';
                        itemEl.innerHTML = `
                            <span>${item.name} x ${item.quantity}</span>
                            <span class="font-medium">${formatRupiah(itemTotal)}</span>
                        `;
                        summaryItems.appendChild(itemEl);
                    });
                    
                    total = subtotal; 
                }

                // Update Ringkasan
                subtotalEl.textContent = formatRupiah(subtotal);
                totalAmountEl.textContent = formatRupiah(total);
            }

            // Jalankan load cart saat halaman dimuat
            loadCart();

            // Handle Checkout Submission
            checkoutForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                if (!checkoutForm.checkValidity()) {
                    showCustomMessage("Mohon lengkapi semua kolom yang wajib diisi.", 'warning');
                    return;
                }

                if (cartItems.length === 0) {
                    showCustomMessage("Keranjang Anda kosong. Tidak dapat melakukan pemesanan.", 'warning');
                    return;
                }
                
                // ⭐️ LOGIKA KRITIS: Hapus keranjang dari Supabase
                try {
                    // Ini mengosongkan keranjang di database, sehingga persisten.
                    const { error } = await supabase
                        .from('carts')
                        .delete()
                        .eq('user_id', user.id); // Hapus semua item keranjang user ini
                    
                    if (error) throw error;

                    // 1. Get form data (simulated)
                    const formData = new FormData(checkoutForm);
                    const orderData = Object.fromEntries(formData.entries());
                    orderData.items = cartItems;
                    orderData.totalAmount = total;
                    orderData.userId = user.id; // Tambahkan ID user

                    // 2. Clear cart status dan simpan data pesanan
                    sessionStorage.removeItem("cartItems"); 
                    localStorage.removeItem("cart"); // Hapus keranjang utama di localStorage (jika masih ada)
                    localStorage.setItem("lastOrderData", JSON.stringify(orderData)); // Simpan data pesanan (simulasi)

                    // 3. Redirect (simulated confirmation)
                    showCustomMessage("Pesanan berhasil ditempatkan! Keranjang telah dikosongkan.", 'success');
                    setTimeout(() => {
                        window.location.href = "index.html?order=success";
                    }, 1500);

                } catch (error) {
                    console.error("Gagal saat Checkout atau menghapus keranjang Supabase:", error);
                    showCustomMessage(`Checkout gagal: ${error.message}. Keranjang mungkin belum terhapus.`, 'warning');
                }
            });
        });
    </script>
</body>
</html>